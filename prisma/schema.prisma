generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums reflecting business domain
enum SupplierStatus {
  ACTIVE
  INACTIVE
}

enum SupplierCategory {
  SUPPLIERS       // ספקים קבועים (ישן)
  ADHOC           // ספק מזדמן (ישן)
  DIRECT_DEBIT    // הוראת קבע (ישן)
  AUTHORITIES     // רשויות (ישן)
  FX              // מט"ח (ישן)
  PERMANENT       // ספק קבוע (חדש)
  OCCASIONAL      // ספק מזדמן (חדש)
}

enum SupplierType {
  REGULAR         // רגיל
  FX_TYPE         // מט"ח
  DIRECT_DEBIT_TYPE    // הוראת קבע
}

enum PaymentTerms {
  IMMEDIATE       // מיידי
  YEARLY          // שנתי
  MONTHLY         // חודשי
  BI_MONTHLY      // דו-חודשי
  PARTNER_30      // שותף+30
  PARTNER_60      // שותף+60
  PARTNER_90      // שותף+90
  PARTNER_120     // שותף+120
}

enum SupplierSubcategory {
  MATERIALS           // חומרים (ישן)
  SERVICES            // שירותים (ישן)
  SOFTWARE_SYSTEMS    // מערכות ותוכנות (ישן)
  OFFICE_EQUIPMENT    // ציוד ומשרדי (ישן)
  SUBCONTRACTOR       // קבלן משנה (ישן)
  MARKETING           // שיווק ופרסום (ישן)
  FOOD_BEVERAGE       // מזון ומשקאות (ישן)
  ENERGY_INFRA        // אנרגיה ותשתיות (ישן)
  PROPERTY_SERVICES   // שירותי נכס (ישן)
  MAINTENANCE         // תחזוקה (ישן)
  GENERAL             // כללי (ישן)
  VEHICLE             // רכב (ישן)
  LOGISTICS           // הובלות (ישן)
  RAW_MATERIALS       // חומר גלם ופירזול (חדש)
  PAINT_SERVICES      // שירותי צבע (חדש)
  TRANSPORTATION      // הובלה (חדש)
  ASSEMBLY            // הרכבה (חדש)
  SOFTWARE_IT         // תוכנות ומיחשוב (חדש)
  MAINTENANCE_NEW     // תחזוקה (חדש)
  AUTHORITIES         // רשויות (חדש)
  COMMUNICATION       // תקשורת (חדש)
  OFFICE              // משרדי (חדש)
  FOOD                // מזון (חדש)
  CLOTHING            // ביגוד (חדש)
  VEHICLE_NEW         // רכב (חדש)
  EQUIPMENT_PURCHASE  // רכישת ציוד (חדש)
  OTHER_SERVICES      // שירותים אחרים (חדש)
  SUBCONTRACTOR_NEW   // קבלנות משנה (חדש)
}

enum InvoiceType {
  INVOICE              // חשבונית רגילה
  TAX_INVOICE          // חשבונית מס
  TAX_INVOICE_RECEIPT  // חשבונית מס קבלה
  CREDIT               // חשבונית זיכוי
}

enum InvoiceCategory {
  REGULAR
  FX
  DIRECT_DEBIT
  AUTHORITIES
}

enum PaymentMethod {
  CASH
  CHECK
  CREDIT_CARD
  BANK_TRANSFER
  BIT
  DIRECT_DEBIT
}

model Supplier {
  id            Int                     @id @default(autoincrement())
  name          String                  @unique
  status        SupplierStatus          @default(ACTIVE)
  category      SupplierCategory        @default(PERMANENT)
  subcategory   SupplierSubcategory?
  type          SupplierType?
  paymentMethod PaymentMethod?
  paymentTerms  PaymentTerms?
  contact       String?
  phone         String?
  email         String?
  taxId         String?
  address       String?
  notes         String?
  invoices      Invoice[]
  payments      Payment[]
  recurringExpenses RecurringExpense[]
  createdAt     DateTime                @default(now())
  updatedAt     DateTime                @updatedAt
}

model Invoice {
  id           Int               @id @default(autoincrement())
  supplierId   Int
  number       String            // אסמכתא/מספר חשבונית
  type         InvoiceType       @default(INVOICE)
  category     InvoiceCategory   @default(REGULAR)
  date         DateTime
  dueDate      DateTime?
  currency     String            @default("ILS")
  subtotal     Decimal           @default(0)
  vat          Decimal           @default(0)
  total        Decimal           @default(0)
  status       String            @default("OPEN") // OPEN | PARTIALLY_PAID | PAID | CANCELED
  reference    String?
  description  String?
  lines        InvoiceLine[]
  allocations  PaymentAllocation[]
  supplier     Supplier          @relation(fields: [supplierId], references: [id])
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
}

model InvoiceLine {
  id        Int      @id @default(autoincrement())
  invoiceId Int
  description String
  qty       Decimal @default(1)
  unitPrice Decimal @default(0)
  total     Decimal @default(0)
  invoice   Invoice @relation(fields: [invoiceId], references: [id])
}

model Payment {
  id           Int            @id @default(autoincrement())
  supplierId   Int
  date         DateTime
  method       PaymentMethod
  amount       Decimal
  currency     String         @default("ILS")
  reference    String?        // פרטי אסמכתא
  details      String?
  allocations  PaymentAllocation[]
  supplier     Supplier       @relation(fields: [supplierId], references: [id])
  createdAt    DateTime       @default(now())
}

model PaymentAllocation {
  id         Int     @id @default(autoincrement())
  paymentId  Int
  invoiceId  Int
  amount     Decimal
  payment    Payment @relation(fields: [paymentId], references: [id])
  invoice    Invoice @relation(fields: [invoiceId], references: [id])
}

enum RecurrenceFrequency {
  MONTHLY
  BIMONTHLY
  QUARTERLY
  SEMIANNUAL
  ANNUAL
}

model RecurringExpense {
  id          Int                 @id @default(autoincrement())
  supplierId  Int
  title       String
  amount      Decimal
  dayOfMonth  Int                 // חיוב חודשי ביום X
  frequency   RecurrenceFrequency @default(MONTHLY)
  fixedCategory SupplierCategory  @default(SUPPLIERS) // SUPPLIERS or other existing values
  active      Boolean             @default(true)
  notes       String?
  supplier    Supplier            @relation(fields: [supplierId], references: [id])
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
}

